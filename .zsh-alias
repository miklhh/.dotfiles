#
# Configuration is very miniscule but it does the job both for faint tty sessions and in
# interactive colored terminal emulators. If Powerlevel10k is available it is sourced.
# If not fallback prompt is available.
#
# Author: Mikael Henriksson (www.github.com/miklhh)
#


# ------------------------------------------------------------------------------------ #
# --                                Settings for ls                                 -- #
# ------------------------------------------------------------------------------------ #

function _ls_gnu {
    ls                              \
        --classify                  \
        --color                     \
        --group-directories-first   \
        --human-readable            \
        "${@}" # Forward arguments
}
function _ls_bsd {
    ls -G "${@}" # Forward arguments
}

if [ $(uname -s) = "Darwin" ]
then
    if command -v gls 1>/dev/null 2>&1; then
        alias ls=_ls_gnu
    else
        echo "[ .zsh-alias:${LINENO} ]:" \
             "Warning: 'GNU coreutils' not installed, using 'BSD ls'"
        alias ls=_ls_bsd
    fi
else
    alias ls=_ls_gnu
fi

alias l='ls -l'
alias ll='ls -l -a'

# ------------------------------------------------------------------------------------ #
# --                              NeoVim+Tmux integration                           -- #
# ------------------------------------------------------------------------------------ #

if command -v "nvim" 1>/dev/null; then
    if command -v "tmux" 1>/dev/null 2>&1; then
        function _nvim_in_tmux() {
            if [ -z "${TMUX}" ]; then
                tmux new-session -d
                tmux send-keys "nvim $@" Enter
                tmux attach
            else
                nvim "$@"
            fi
        }
        alias vim=_nvim_in_tmux
    else
        alias vim=nvim
    fi
else
    echo "[ .zsh-alias:${LINENO} ]: Warning: 'nvim' not in \${PATH}"
fi

function _tmux_cd_relative {
    local target=${1}
    cd $(tmux display-message -p -F "#{pane_current_path}" -t "{$target}"  || echo ".")
}
alias cdl='_tmux_cd_relative left-of'
alias cdr='_tmux_cd_relative right-of'
alias cdu='_tmux_cd_relative up-of'
alias cdd='_tmux_cd_relative down-lf'


# ------------------------------------------------------------------------------------ #
# --                            Change dir FZF style                                -- #
# ------------------------------------------------------------------------------------ #

# * Command 'c'  : Use FZF to change directory forward, from the current directory
# * Command 'C'  : Use FZF to change directory backward, from the current directory
# * Command 'ch' : Use FZF to change directory forward, from $USER's home directory

if command -v fzf 1>/dev/null 2>&1; then
    function _fzf_cd_preview {
        local extra_cmd="${1}"
        fzf                 \
            --border        \
            --height=50%    \
            --info=inline   \
            --reverse       \
            ${extra_cmd}    \
            --preview 'tree --dirsfirst -L 1 -C {} | head -200'
    }
    function _generate_backward_dir_list() {
        local PARAM="$1"
        local REM="$(pwd)"
        local PART=""
        if [ "$PARAM" = "--exclude" ]; then
            while [ ! -z "$REM" ]; do
                echo "$PART"
                IFS="/" read CUR REM <<< "$REM"
                local PART="${PART}${CUR}/"
            done
        else
            while [ ! -z "$REM" ]; do
                IFS="/" read CUR REM <<< "$REM"
                local PART="${PART}${CUR}/"
                echo "$PART"
            done
        fi
    }
    function _bfs_dir_search() {
        bfs "$1" -type d -exclude -name .git 2>/dev/null | sed "s|\./||g"
    }
    function _rfs_dir_search() {
        rfs -p "$1" -i .git 2>/dev/null | sed "s|\./||g"
    }
    function _find_dir_search() {
        find . -type d 2>/dev/null | sed "s|\./||g"
    }
    if command -v bfs 1>/dev/null 2>&1; then
        # Prio 1: Breadth first directory search using 'bfs', has top priority of the 
        #         directory search utilities as it tends to find the desiered directory
        #         the fastest.
        alias _dir_search=_bfs_dir_search
    elif command -v rfs 1>/dev/null 2>&1; then
        # Prio 2: Directory search using the Rust first search utility. Not as good as
        #         bfs, but it supports multithreaded depth first search, so it has the
        #         potential to perform better than the find utility.
        alias _dir_search=_rfs_dir_search
    else
        # Prio 3: Directory search using the common 'find' utility. Slow and
        #         ugly, but gets the job done.
        alias _dir_search=_find_dir_search
    fi
    function _fzf_cd_backward {
        cd "$(_generate_backward_dir_list --exclude | _fzf_cd_preview --tac || echo .)"
    }
    function _fzf_cd_forward {
        local start_dir="${1}"
        cd "$(_dir_search ${start_dir} | _fzf_cd_preview || echo .)"
    }
    alias  C=_fzf_cd_backward
    alias  c='_fzf_cd_forward .'
    alias ch='_fzf_cd_forward ~'
else
    echo "[ .zsh-alias:${LINENO} ]: Warning: 'fzf' not in \${PATH}"
    alias  c="echo \"[ .zsh-alias:${LINENO} ]: Warning: 'fzf' not in \\\${PATH}\""
    alias  C="echo \"[ .zsh-alias:${LINENO} ]: Warning: 'fzf' not in \\\${PATH}\""
    alias ch="echo \"[ .zsh-alias:${LINENO} ]: Warning: 'fzf' not in \\\${PATH}\""
fi


# ------------------------------------------------------------------------------------ #
# --                                    Misc                                        -- #
# ------------------------------------------------------------------------------------ #

# Quick-open files with GNU xdg-open or BSD open
function o {
    if command -v xdg-open 1>/dev/null 2>&1; then
        # Freedesktop (probably GNU/Linux) environment: GNU 'xargs' with 'xdg-open'
        if [ "$#" -eq 0 ]; then
            if command -v fzf 1>/dev/null 2>&1; then
                fzf --height=15 --print0 |
                    xargs -r -0 -I"{}" sh -c 'xdg-open "{}" 1>/dev/null 2>&1 &'
            else
                echo "Error: 'fzf' not in \${PATH}"
            fi
        else
            xdg-open "$1" 1>/dev/null 2>&1
        fi
    elif command -v open 1>/dev/null 2>&1; then
        # MacOS/BSD environment: BSD 'xargs' with BSD 'open'
        if [ "$#" -eq 0 ]; then
            if command -v fzf 1>/dev/null 2>&1; then
                fzf --height=15 --print0 |
                    xargs -r -0 -I"{}" sh -c 'open "{}" 1>/dev/null 2>&1 &'
            else
                echo "Error: 'fzf' not in \${PATH}"
            fi
        else
            open "$1" 1>/dev/null 2>&1
        fi
    else
        # No 'xdg-open' or 'open' in $PATH
        echo "[ .zsh-alias:${LINENO} ]: Warning: 'xdg-open/open' not in \${PATH}"
    fi
}

# Open current directory with xdg-open/open
if command -v xdg-open 1>/dev/null 2>&1; then
    # Freedesktop environment: GNU 'xdg-open'
    alias op='xdg-open .'
elif command -v open 1>/dev/null 2>&1; then
    # MacOS environment: BSD 'open'
    alias op='open .'
else
    echo "[ .zsh-alias:${LINENO} ]: Warning: 'xdg-open/open' not in \${PATH}"
fi

# Python 3 alias. On certain systems, e.g. Ubuntu, python is not linked to either
# Python 2 nor Python 3
if ! command -v python 1>/dev/null 2>&1; then
    alias python='python3'
fi

# On MacOS Darwin: make an alias python->python3
if [ "$(uname -s)" = "Darwin" ]; then
    alias python='python3'
fi

# (i)Python calculator
PYTHON_CALC_INIT_CMD='import math; import matplotlib.pyplot as plt; import numpy as np;'
if command -v ipython 1>/dev/null 2>&1; then
    # Ipython with Vim keybindings and _without_ QT backend (nice..)
    alias calc="ipython -i -c '${PYTHON_CALC_INIT_CMD}'"
else
    # Regular python calculator (lame..)
    echo "[ .zsh-alias:${LINENO} ]: Warning: 'ipython' not in \${PATH}"
    alias calc="python3 -i -c '${PYTHON_CALC_INIT_CMD}'"
fi

# Create a new directory and change to it
function _mkdir_and_cd() {
    local MKPATH="${1}"
    mkdir -p "${MKPATH}"
    cd "${MKPATH}"
}

# Command line quickies
alias ca=cargo
alias t=tmux
alias ta='tmux attach -t'
alias g=git
alias m=_mkdir_and_cd

